---
title: "Mbita Kenya Ab study"
output:
  html_notebook:
    highlight: haddock
    theme: default
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---


# Preamble
```{r preamble}
library(here)
here()

library(tidyverse)
library(mgcv)
library(foreach)
library(gridExtra)

# grab some colors for plotting
ggplotcols <- scales::hue_pal()(3)
# bright color blind palette:  https://personal.sron.nl/~pault/ 
cblack <- "#000004FF"
cblue <- "#3366AA"
cteal <- "#11AA99"
cgreen <- "#66AA55"
cchartr <- "#CCCC55"
cmagent <- "#992288"
cred <- "#EE3333"
corange <- "#EEA722"
cyellow <- "#FFEE33"
cgrey <- "#777777"

pcols <- c(ggplotcols,cmagent,corange)

```

# Load coastal Kenya measurements
Load AsHb measurements and filter 

```{r load data, warning=FALSE}
d <- readRDS(here("data","mbita_psac.rds"))

# create age strata
d <- d %>%
  select(year,community=vid,
         pid,age=agey,
         wat01,toi01,
         msp1,sea,sm25,ashb,nie,vsp5) %>%
  mutate(agecat = cut(age,breaks=c(0,1,2,3,4,6)))

# reshape to long format
dl <- d %>%
  select(year,community,wat01,toi01,age,agecat,msp1,sea,nie,ashb,vsp5) %>%
  gather(key=antigen,value=mfi,-year,-community,-wat01,-toi01,-age,-agecat) %>%
  mutate(antigen = factor(antigen,levels=c("ashb","nie","sea","msp1","vsp5"))) %>%
  group_by(year,community,antigen) %>%
  arrange(year,community,antigen,age)

dl <- dl %>%
  mutate(logmfi = ifelse(mfi>0,log10(mfi),log10(1)))

# add ROC-based cutoffs
dl$roccut <- NA
dl$roccut[dl$antigen %in% "msp1"] <- log10(170)
dl$roccut[dl$antigen %in% "sea"] <- log10(965)
dl$roccut[dl$antigen %in% "ashb"] <- log10(418)
dl$roccut[dl$antigen %in% "nie"] <- log10(659)
dl$roccut[dl$antigen %in% "vsp5"] <- log10(281)

# define seroprevalence based on ROC cutoffs
dl <- dl %>%
  mutate(seropos = ifelse(logmfi>roccut,1,0))


# create formatted antigen labels
dl <- dl %>%
  mutate(antigenf=factor(antigen,levels=c("ashb","nie","sea","msp1","vsp5"),
                         labels=c("Ascaris spp. AsHb",
                                  "S. stercoralis NIE",
                                  "S. mansoni SEA",
                                  "P. falciparum MSP-1",
                                  "Giardia spp. VSP-5")))


```


# Age stratified distributions

```{r density plot by age}

table(dl$agecat,dl$antigenf)

pdist <- ggplot(data=dl,aes(x=logmfi,fill=antigen)) +
  facet_grid(agecat~antigenf) +
  geom_density(alpha=0.5,color=NA) +
  geom_vline(aes(xintercept = roccut),lty=1) +
  scale_fill_manual(values=pcols)+
  # geom_vline(aes(xintercept = mixcut),lty=2) +
  labs(x="log10 luminex response (MFI-bg)") +
  theme_minimal() + 
  theme(legend.position = "none",
        strip.text.y=element_text(angle=0))

pdist


pdist2 <- ggplot(data=dl,aes(x=logmfi,fill=antigenf)) +
  facet_grid(.~antigenf) +
  geom_density(alpha=0.5,color=NA) +
  geom_vline(aes(xintercept = roccut),lty=1) +
  scale_fill_manual(values=pcols)+
  # geom_vline(aes(xintercept = mixcut),lty=2) +
  labs(x="log10 luminex response (MFI-bg)") +
  theme_minimal() + 
  theme(legend.position = "none",
        strip.text.y=element_text(angle=0))

pdist2

# save png file for presentation
ggsave(filename=here("output","mbita-ab-dists.png"),plot=pdist2,device="png",width=8,height=2.5)

```


# Age dependent means and seroprevalence

## Function for a simultaneous CI around a spline curve
```{r simultaneous CI}
#----------------------------------
# simulataneous CIs for GAMs
# estimated by resampling the 
# Baysian posterior estimates of
# the variance-covariance matrix
# assuming that it is multivariate normal
# the function below also estimates 
# the unconditional variance-covariance
# matrix, Vb=vcov(x,unconditional=TRUE), 
# which allows for undertainty in the actual
# estimated mean as well 
# (Marra & Wood 2012 Scandinavian Journal of Statistics, 
#  Vol. 39: 53â€“74, 2012, doi: 10.1111/j.1467-9469.2011.00760.x )
# simultaneous CIs provide much better coverage than pointwise CIs
# see: http://www.fromthebottomoftheheap.net/2016/12/15/simultaneous-interval-revisited/
#----------------------------------

gamCI <- function(m,newdata,nreps=10000) {
  require(mgcv)
  require(dplyr)
  Vb <- vcov(m,unconditional = TRUE)
  pred <- predict(m, newdata, se.fit = TRUE)
  fit <- pred$fit
  se.fit <- pred$se.fit
  BUdiff <- MASS::mvrnorm(n=nreps, mu = rep(0, nrow(Vb)), Sigma = Vb)
  Cg <- predict(m, newdata, type = "lpmatrix")
  simDev <- Cg %*% t(BUdiff)
  absDev <- abs(sweep(simDev, 1, se.fit, FUN = "/"))
  masd <- apply(absDev, 2L, max)
  crit <- quantile(masd, prob = 0.95, type = 8)
  pred <- data.frame(newdata,fit=pred$fit,se.fit=pred$se.fit)
  pred <- mutate(pred,
                 uprP = fit + (2 * se.fit),
                 lwrP = fit - (2 * se.fit),
                 uprS = fit + (crit * se.fit),
                 lwrS = fit - (crit * se.fit)
  )
  return(pred)
}

```

## Select smoothing parameters with CV
```{r smoothing parameter selection by CV}
#----------------------------------
# prep data for spline fits
#----------------------------------
dl <- dl %>% 
  ungroup() %>%
  mutate(community=factor(community),
         dummy=1)
#----------------------------------
# choose the smoothing parameter
# for the splines, k, 
# based on cross-validated MSE
# pick smallest k where CV MSE is 
# close to its minimum
#----------------------------------
# library(SuperLearner)
# library(mgcv)
# source(here("R","SL.mgcv.R")) # mgcv wrapper for SuperLearner
# # k=4
# set.seed(123)
# sld <- filter(dl,antigen=="msp1")
# cv_msp1 <- SuperLearner(Y=sld$logmfi,X=select(sld,age), SL.library = paste("SL.mgcv.k",4:10,sep=""))
# cv_msp1
# # k=4
# set.seed(123)
# sld <- filter(dl,antigen=="vsp5")
# cv_vsp5 <- SuperLearner(Y=sld$logmfi,X=select(sld,age), SL.library = paste("SL.mgcv.k",4:10,sep=""))
# cv_vsp5
# # k=4
# set.seed(123)
# sld <- filter(dl,antigen=="ashb")
# cv_ashb <- SuperLearner(Y=sld$logmfi,X=select(sld,age), SL.library = paste("SL.mgcv.k",4:10,sep=""))
# cv_ashb
# # k=4
# set.seed(123)
# sld <- filter(dl,antigen=="nie")
# cv_nie <- SuperLearner(Y=sld$logmfi,X=select(sld,age), SL.library = paste("SL.mgcv.k",4:10,sep=""))
# cv_nie
# # k=4
# set.seed(123)
# sld <- filter(dl,antigen=="sea")
# cv_sea <- SuperLearner(Y=sld$logmfi,X=select(sld,age), SL.library = paste("SL.mgcv.k",4:10,sep=""))
# cv_sea
```

## Age dependent means
```{r agecurves mfi}

#----------------------------------
# fit GAM with a spline for age
# include a random effect for cluster
# estimate simultaneous CIs around the curve
# for the prediction data, set the dummy to 0 to 
# zero out all of the random effects
# see posts on Stack Exchange for explanation:
# https://stats.stackexchange.com/questions/131106/predicting-with-random-effects-in-mgcv-gam/131116#131116
# https://stats.stackexchange.com/questions/189384/predicting-mean-smooth-in-gam-with-smooth-by-random-factor-interaction
#----------------------------------


# Pf Malaria MSP1 
fit_msp1 <- mgcv::gam(logmfi~s(age,bs="cr",k=4) + s(community,bs="re",by=dummy), 
                      data=filter(dl,antigen=="msp1"))
newd <- dl %>% filter(antigen=="msp1") %>% mutate(dummy=0)
fit_msp1ci <- gamCI(m=fit_msp1,newdata=newd,nreps=10000)

# Giardia VSP5
fit_vsp5 <- mgcv::gam(logmfi~s(age,bs="cr",k=4) + s(community,bs="re",by=dummy), 
                      data=filter(dl,antigen=="vsp5"))
newd <- dl %>% filter(antigen=="vsp5") %>% mutate(dummy=0)
fit_vsp5ci <- gamCI(m=fit_vsp5,newdata=newd,nreps=10000)

# Ascaris AsHb
fit_ashb <- mgcv::gam(logmfi~s(age,bs="cr",k=4) + s(community,bs="re",by=dummy), 
                      data=filter(dl,antigen=="ashb"))
newd <- dl %>% filter(antigen=="ashb") %>% mutate(dummy=0)
fit_ashbci <- gamCI(m=fit_ashb,newdata=newd,nreps=10000)

# Strongy NIE
fit_nie <- mgcv::gam(logmfi~s(age,bs="cr",k=4) + s(community,bs="re",by=dummy), 
                      data=filter(dl,antigen=="nie"))
newd <- dl %>% filter(antigen=="nie") %>% mutate(dummy=0)
fit_nieci <- gamCI(m=fit_nie,newdata=newd,nreps=10000)

# Schisto SEA
fit_sea <- mgcv::gam(logmfi~s(age,bs="cr",k=4) + s(community,bs="re",by=dummy), 
                      data=filter(dl,antigen=="sea"))
newd <- dl %>% filter(antigen=="sea") %>% mutate(dummy=0)
fit_seaci <- gamCI(m=fit_sea,newdata=newd,nreps=10000)

fit_mfi <- bind_rows(fit_msp1ci,fit_vsp5ci,fit_ashbci,fit_nieci,fit_seaci)

```

```{r mean mfi by age plot}

pagemfi <- ggplot(data=fit_mfi,aes(x=age,y=fit,color=antigen)) +
  facet_grid(~antigen) +
  geom_point(aes(x=age,y=logmfi),alpha=0.1,size=0.2)+
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA,fill="black") +
  geom_line(lwd=0.5,alpha=0.5,color="black") +
  geom_smooth(method="loess",se=FALSE,lwd=0.5,color="black") +
  scale_color_manual(values=pcols)+
  scale_y_continuous(breaks=seq(0,4,by=1))+
  labs(x="age, years",y="log10 Luminex Response (MFI-bg)") +
  theme_minimal() +
  theme(legend.position="none")

pagemfi


```

## Age dependent seroprevalence
```{r agecurves seroprev}

# Pf Malaria MSP1 
fitp_msp1 <- mgcv::gam(seropos~s(age,bs="cr",k=4) + s(community,bs="re",by=dummy), 
                      data=filter(dl,antigen=="msp1"))
newd <- dl %>% filter(antigen=="msp1") %>% mutate(dummy=0)
fitp_msp1ci <- gamCI(m=fitp_msp1,newdata=newd,nreps=10000)

# Giardia VSP5
fitp_vsp5 <- mgcv::gam(seropos~s(age,bs="cr",k=4) + s(community,bs="re",by=dummy), 
                      data=filter(dl,antigen=="vsp5"))
newd <- dl %>% filter(antigen=="vsp5") %>% mutate(dummy=0)
fitp_vsp5ci <- gamCI(m=fitp_vsp5,newdata=newd,nreps=10000)


# Ascaris AsHb
fitp_ashb <- mgcv::gam(seropos~s(age,bs="cr",k=11) + s(community,bs="re",by=dummy), family="binomial",
                      data=filter(dl,antigen=="ashb"))
newd <- dl %>% filter(antigen=="ashb") %>% mutate(dummy=0)
fitp_ashbci <- gamCI(m=fitp_ashb,newdata=newd,nreps=10000)

# Strongy NIE
fitp_nie <- mgcv::gam(seropos~s(age,bs="cr",k=7) + s(community,bs="re",by=dummy), family="binomial", 
                      data=filter(dl,antigen=="nie"))
newd <- dl %>% filter(antigen=="nie") %>% mutate(dummy=0)
fitp_nieci <- gamCI(m=fitp_nie,newdata=newd,nreps=10000)

# Schisto SEA
fitp_sea <- mgcv::gam(seropos~s(age,bs="cr",k=9) + s(community,bs="re",by=dummy), family="binomial", 
                      data=filter(dl,antigen=="sea"))
newd <- dl %>% filter(antigen=="sea") %>% mutate(dummy=0)
fitp_seaci <- gamCI(m=fitp_sea,newdata=newd,nreps=10000)

fit_seroprev <- bind_rows(fitp_msp1ci,fitp_vsp5ci,fitp_ashbci,fitp_nieci,fitp_seaci)

# convert linear predictor to prevalance
expitfn <- function(x) {
  exp(x)/(1+exp(x))
}
fit_seroprev <- fit_seroprev %>%
  mutate(fit = expitfn(fit),
         uprP = expitfn(uprP),
         lwrP = expitfn(lwrP),
         uprS = expitfn(uprS),
         lwrS = expitfn(lwrS),
         )

```

```{r seroprev by age plot}

pageprev <- ggplot(data=fit_seroprev,aes(x=age,y=fit,color=antigen)) +
  facet_grid(~antigen) +
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA,fill="grey50") +
  geom_line(lwd=0.5,alpha=0.5) +
  geom_smooth(method="loess",se=FALSE,lwd=0.5) +
  scale_color_manual(values=pcols)+
  scale_y_continuous(breaks=seq(0,0.8,by=0.1),labels=seq(0,80,by=10))+
  labs(x="age, years",y="Seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")

pageprev


```
# Cluster level seroprevalence vs. means

```{r cluster means}

dlc <- dl %>%
  group_by(community,antigenf) %>%
  mutate(posroc=ifelse(logmfi>roccut,1,0)) %>%
  summarize(n=n(),
            meanmfi=mean(logmfi),
            prevroc=mean(posroc))

# estimate pearson correlation
dcorr <- dlc %>%
  ungroup() %>%
  group_by(antigenf) %>%
  mutate(corroc=cor(meanmfi,prevroc,method="pearson")) %>%
  slice(1)

# estimate regression slope
foreach(ai=levels(dlc$antigenf)) %do% {
  di <- dlc %>% filter(antigenf==ai)
  fit <- lm(prevroc~meanmfi,data=di)
  summary(fit)
}
```


```{r prev vs mfi figure}
pmfivprev <- ggplot(data=dlc,aes(x=meanmfi,color=antigenf)) +
  facet_grid(~antigenf) +
  geom_point(aes(y=prevroc),alpha=0.7) +
  geom_smooth(aes(y=prevroc),method="glm",color="gray40",lwd=0.5,se=FALSE) +
  geom_text(data=dcorr,
            aes(x=2.5,y=0.95,label=paste("r ==",sprintf("%1.2f",corroc)) ),
            parse=TRUE,col="grey30") +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=seq(0,100,by=20))+
  scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,1),xlim=c(1,4.5)) +
  labs(x="community mean log10 MFI",y="community seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")
pmfivprev

# save png file for presentation
ggsave(filename=here("output","mbita-mfi-v-seroprev.png"),plot=pmfivprev,device="png",width=10,height=2.5)


```

# Comparison with FOI

## Constant rate model
Estimate community-level FOI for P. falciparum S. mansoni based on the seroconversion rate (incidence among susceptibles). Assume a constant rate model (i.e., average over all ages).  If we assume a constant force of infection ($\lambda$), equivalent to assuming an exponential model, then it can be shown that a generalized linear model with a complementary log-log link fit with current status, age-prevalence data is equivalent to an exponential proportional hazards model (*Jewell and van der Laan 1995*). 

$\log - \log(1-P(Y|A,W)) = \log \lambda + \log A + \beta W$

Moroever, this model is also equivalent to a catalytic, SIR model with a single, constant rate parameter (*Hens et al. 2010*; *Hens et al. 2012*).

```{r  foi estimation for msp and sea}

foi_ests <- foreach(ai=c("S. mansoni SEA","P. falciparum MSP-1"),.combine=rbind) %:%
  foreach(comi=levels(dl$community),.combine=rbind) %do% {
  
  di <- dl %>% filter(antigenf==ai & community==comi)
  gfit <- glm(seropos~1,offset=log(age),data=di,family=binomial(link="cloglog"))
  gsum <- summary(gfit)
  lambda <- as.numeric(exp(gfit$coefficients))
  log_lambda_se  <- sqrt(gsum$cov.unscaled)
  lambda_lb <- as.numeric(exp(gfit$coefficients - 1.96*log_lambda_se))
  lambda_ub <- as.numeric(exp(gfit$coefficients + 1.96*log_lambda_se))
  res <- data.frame(community=comi,antigenf=ai,lambda,lambda_lb,lambda_ub)
  return(res)
}

foi_ests

```



```{r merge foi estimates}
# merge FOI estimates to the cluster-level means
d_foi <- dlc %>%
  filter(antigenf=="S. mansoni SEA"|antigenf=="P. falciparum MSP-1") %>%
  left_join(foi_ests,by=c("community","antigenf")) %>%
  mutate(antigenf=factor(antigenf,levels=c("S. mansoni SEA","P. falciparum MSP-1")))


# estimate spearman correlation
dfoicorr <- d_foi %>%
  ungroup() %>%
  group_by(antigenf) %>%
  mutate(cormfi=cor(meanmfi,lambda,method="spearman"),
         corprev=cor(prevroc,lambda,method="spearman")) %>%
  slice(1)

```

Figure of results
```{r foi vs mfi figure}
pfoivmfi <- ggplot(data=d_foi,aes(x=meanmfi,y=lambda,color=antigenf)) +
  facet_grid(~antigenf)+
  geom_point(,alpha=0.7) +
  # geom_smooth(method="glm",color="gray40",lwd=0.5,se=FALSE) +
  geom_smooth(method="loess",color="gray40",lwd=0.5,se=FALSE) +
  geom_text(data=dfoicorr,
            aes(x=2.5,y=0.6,label=paste("rho ==",sprintf("%1.2f",cormfi)) ),
            parse=TRUE,col="grey30") +
  scale_x_continuous(breaks=2:4)+
  scale_color_manual(values=pcols[c(3,4)])+
  coord_cartesian(xlim=c(2,4.5),ylim=c(0,0.7)) +
  labs(x="community mean log10 MFI",y=expression(paste("community seroconversion rate (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="none")
pfoivmfi

# save png file for presentation
ggsave(filename=here("output","mbita-mfi-v-foi.png"),plot=pfoivmfi,device="png",width=5,height=3)

```
```{r foi vs prev figure}
pfoivprev <- ggplot(data=d_foi,aes(x=prevroc,y=lambda,color=antigenf)) +
  facet_grid(~antigenf)+
  geom_point(alpha=0.7) +
  # geom_smooth(method="glm",color="gray40",lwd=0.5,se=FALSE) +
  geom_smooth(method="loess",color="gray40",lwd=0.5,se=FALSE) +
  geom_text(data=dfoicorr,
            aes(x=0.2,y=0.6,label=paste("rho ==",sprintf("%1.2f",corprev)) ),
            parse=TRUE,col="grey30") +
  scale_x_continuous(breaks=seq(0,1,by=0.2),labels=seq(0,100,by=20))+
  scale_color_manual(values=pcols[c(3,4)])+
  coord_cartesian(xlim=c(0,1),ylim=c(0,0.7)) +
  labs(x="community seroprevalence (%)",y=expression(paste("community seroconversion rate (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="none")
pfoivprev


```

## Semiparametric rate model

Semiparametric estimates provide age-specific rates. To compare the estimator with constant rate models, we can average over the empirical distribution of age in the study population.  
$\hat{\lambda} = \int_a \lambda(a) P(A=a)$

```{r pop avg foi from gam}
# # ----------------------------
# # function to estimate the
# # average FOI over empirical
# # age distribution
# # the predictions are based
# # on a spline fit and its
# # derivative
# # gridA is a grid of predicted
# # ages
# # pA is the empirical
# # age distribution
# # ----------------------------
# 
# pAfoi <- function(m,gridA,pA,eps=1e-07,level=0.95,nreps=10000) {
#   
#   # variance-covariance matrix from the spline fit
#   # unconditional on the fit of the mean
#   # this is slightly more conservative and with better coverage
#   # properties. 
#   # See Marra G, Wood SN. 
#   # Coverage Properties of Confidence Intervals 
#   # for Generalized Additive Model Components.   
#   # Scand Stat Theory Appl. 2012;39: 53â€“74.
#   Vb <- vcov(m,unconditional = TRUE)
#   
#   # calculate the linear predictor, g(Ft), and its pointwise SE
#   pred <- predict(m, newdata=gridA, se.fit = TRUE)
#   Ft <- pred$fit
#   Ft.se <- pred$se.fit
# 
#   # calculate the derivative, g'(Ft), using
#   # finite differences and its pointwise SE
#   # ?mgcv::predict.gam includes an example of this
#   X0 <- predict(m, gridA, type = "lpmatrix")
#   gridA2 <- gridA+eps
#   X1 <- predict(m,gridA2,type='lpmatrix')
#   Xp <- (X1 - X0) / eps
#   ft <- Xp %*% coef(m)
#   ft.se <- rowSums(Xp %*% Vb * Xp)^0.5
#   
#   # parametric bootstrap simulation from the
#   # model coefficient estimates, assuming the model is true
#   # FOI is the derivative of the linear predictor
#   # multiplied by the predicted probability, Ft
#   sims<- MASS::mvrnorm(n = nreps, mu = coef(m), Sigma = Vb)
#   Ft.bs <- X0 %*% t(sims)
#   ft.bs <- Xp %*% t(sims)
#   foi.bs <- ft.bs*(exp(Ft.bs)/(1+exp(Ft.bs)))
#   
#   # merge the parametric bootstrap draws to the empirical 
#   # distribution
#   foi.bs <- data.frame(age=gridA$age,foi.bs)
#   pA_foi.bs <- left_join(data.frame(age=pA),foi.bs,by="age") %>%
#     select(-age)
#   
#   # Average over age for each bootstrap replication
#   foi_bs <- colMeans(pA_foi.bs,na.rm=T)
#   
#   # estimate mean and 
#   # percentile based 95% CIs
#   foi <- mean(foi_bs)
#   foi.se <- sd(foi_bs)
#   foi.ci <- quantile(foi_bs,probs=c(0.025,0.975))  
# 
#   # return objects
#   list(foi=foi,foi.se=foi.se,foi.ci=foi.ci,model=m,gridA=gridA,pA=pA)
#   
# }


# # FOI from spline fits
# agegrid <- data.frame(age=unique(dl$age))
# popavgfoi <- foreach(ab=c("sea","msp1"),.combine=rbind) %:% 
#   foreach(comi=levels(dl$community),.combine=rbind) %do%{
#     pd <- dl %>% filter(antigen==ai & community==comi)
#     mi <- mgcv::gam(seropos~s(age,bs="cr"),data=pd,family="binomial")
#     foii <- pAfoi(m=mi,gridA=agegrid,pA=pd$age)
#     di <- data.frame(antigen=ab,community=comi,
#                      foi=foii$foi,
#                      foi_se=foii$foi.se,
#                      foi_lb=foii$foi.ci[1],
#                      foi_ub=foii$foi.ci[2])
#     return(di)
# }
# 
# 
# # merge semiparametric FOI estimates to the previous estimates
# popavgfoi <- popavgfoi %>% mutate(community=factor(community))
# d_spfoi <- left_join(d_foi,popavgfoi,by=c("antigen","community"))

```

